<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    svg {
      /* border: 1px black solid; */
      background-color: rgb(255, 255, 255);
    }

    .county {
      stroke: none;
    }

    .state {
      stroke: none;
    }

    .county-outline {
      stroke: rgb(255, 255, 255);
      stroke-width: 1px;
      fill: none;
    }

    .state-outline {
      stroke: rgb(255, 255, 255);
      fill: none;
    }

    .label {
      user-select: none;
      pointer-events: none;
    }

    table {
      border: 1px solid black;
    }

    input[type="radio"].toggle {
      display: none;
    }
  </style>
</head>

<body>
  <h1>
    HW2
  </h1>
  <div id="filterButton">
    <input type="radio" id="stateView" name="filterButton" value="state" checked><label for="stateView">State
      View</label>
    <input type="radio" id="countyView" name="filterButton" value="county"><label for="countyView">County View</label>
  </div>
  <svg id="chloroMap" height="600" width="1000"></svg>
  <svg id="legend" height="400" width="400"></svg>
  <div id="tableDiv">
    <table id="table">
      <thead>
        <tr id="header">
          <th>Disability Type (ages)</th>
          <th>%</th>
          <th>MOE</th>
          <th>Number</th>
          <th>MOE</th>
          <th>Base Population</th>
        </tr>
      </thead>
      <tbody>
        <tr id="row1">
          <th>Any Disability (all ages)</td>
          <td>10.1</td>
          <td>±0.8</td>
          <td>10,199</td>
          <td>±799</td>
          <td>101,394</td>
        </tr>
        <tr id="row2">
          <th>Hearing (all ages)</td>
          <td>2.5</td>
          <td>±0.4</td>
          <td>2,574</td>
          <td>±359</td>
          <td>101,394</td>
        </tr>
        <tr id="row3">
          <th>Visual (all ages)</td>
          <td>2.5</td>
          <td>±0.4</td>
          <td>2,574</td>
          <td>±359</td>
          <td>101,394</td>
        </tr>
        <tr id="row4">
          <th>Cognitive (ages 5+)</td>
          <td>2.5</td>
          <td>±0.4</td>
          <td>2,574</td>
          <td>±359</td>
          <td>101,394</td>
        </tr>
        <tr id="row5">
          <th>Ambulatory (ages 5+)</td>
          <td>2.5</td>
          <td>±0.4</td>
          <td>2,574</td>
          <td>±359</td>
          <td>101,394</td>
        </tr>
        <tr id="row6">
          <th>Selfcare (ages 5+)</td>
          <td>2.5</td>
          <td>±0.4</td>
          <td>2,574</td>
          <td>±359</td>
          <td>101,394</td>
        </tr>
        <tr id="row7">
          <th>Independent Living (ages 18+)</td>
          <td>2.5</td>
          <td>±0.4</td>
          <td>2,574</td>
          <td>±359</td>
          <td>101,394</td>
        </tr>
        <!-- Add more rows for each type of disability -->
      </tbody>
    </table>
  </div>

  <script>
    /*  
    =================== hover effect ===========================================
    */
    const labelRectangleHeight = 40;
    const pixelsPerLetter = 10; //used to calculate width of rectangle
    const areaNameFontSize = 14;
    const percentageFontSize = 12;
    const labelVerticalAdjustment = 25;
    /*
    =================== color legends ==========================================
    */
    const stateLegendX = 75; //position from top left corner of the second svg. 
    const stateLegendY = 100;

    const countyLegendX = 250;
    const countyLegendY = 100;

    const boxHeight = 20;
    const boxWidth = 20;
    const boxSeperation = 25; //vertical distances between boxes
    const boxTextSeperation = 25; //horizontal distance between start of the leftmost letter and the left of the box 
    const textVerticalAdjustment = 15; //probably don't change this one unless you change font or font size


    /*
    ========================= table ============================================
    */
    // const tableLabels = [" Disability Type (ages)", "%", "MOE", "Number", "MOE", "Base Population"] const
    //   tableHorizontalLabels = ["Any Disability (all ages)", "Hearing (all ages)", "Visual (all ages)"
    //     , "Cognitive (ages 5+)", "Ambulatory (ages 5+)", "Selfcare (ages 5+)", "Independent Living (ages 18+)"]; const
    //       tablePropertyNames = ["Geography", "percentPopDisability"]; // start work here function

    // generateTable(locationObject);
    function updateTable(dataObject) {
      console.log(dataObject);
      let tbody = d3.select("table#table tbody");

      let rows = tbody.selectAll("tr").data(dataObject);

      rows.each(function (rowData) {
        console.log(rowData);
      });


    }


    async function makeChloro() {
      let topo = await d3.json("us.json"); let
        filteredStates = ['72', '78']; topo.objects.states.geometries = topo.objects.states.geometries.filter(d => {
          return filteredStates.indexOf(d.id.toString().padStart(2, '0')) === -1;
        });

      let disabilityData = await d3.csv("ACSST5Y2022.S1810-Data.csv");

      disabilityData.forEach(d => {
        d["Geography"] = Number(d["Geography"].substr(9));
        d["percentPopDisability"] = Number(d["percentPopDisability"]);
      });


      console.log(disabilityData);

      fipsToStats = {};

      disabilityData.forEach(d => {
        fipsToStats[d["Geography"]] = d;
      });


      // console.log(fipsToStats);

      // console.log(topo);

      let allPercentages = d3.map(disabilityData, d => {
        return Number(d.percentPopDisability);
      });
      let statePercentages = disabilityData.map(d => {
        if (!d["Geographic Area Name"].includes(",")) return d["percentPopDisability"];
      });

      let countyPercentages = disabilityData.map(d => {
        if (d["Geographic Area Name"].includes(",")) return d["percentPopDisability"];
      });


      let colors = ["#CFE1F2", "#B5D4E9", "#93C3DF", "#6DAED5", "#4B97C9", "#2F7EBC", "#1864AA", "#0A4A90", "#08306B"];

      let percentageExtent = d3.extent(allPercentages);
      let adjustedPurple = d3.schemeBlues[9].slice(2);
      console.log(adjustedPurple.slice(1));

      let colorScaleState = d3.scaleQuantize(d3.extent(statePercentages), colors);



      let colorScaleCounty = d3.scaleQuantize(d3.extent(countyPercentages), colors);



      //
      let svg = d3.select("svg#legend");
      let legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${stateLegendX}, ${stateLegendY})`); // Adjust x, y to position your legend

      const numberOfSteps = colorScaleState.range().length;
      const legendData = colorScaleState.range().map((color, i) => {
        const extent = colorScaleState.invertExtent(color);
        return {
          color: color,
          minValue: extent[0],
          maxValue: extent[1]
        };
      });

      svg.append("text")
        .text("Prevalence Rate of Disability (%)")
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "middle")
        .attr("transform", `translate(${200}, ${75})`);


      // Draw legend boxes
      legend.selectAll(".legend-box")
        .data(legendData)
        .enter()
        .append("rect")
        .attr("class", "legend-box")
        .attr("x", 0)
        .attr("y", (d, i) => i * boxSeperation) // Adjust spacing between boxes
        .attr("width", boxWidth) // Adjust size of legend boxes
        .attr("height", boxHeight)
        .style("fill", d => d.color);

      // Add legend labels
      legend.selectAll(".legend-label")
        .data(legendData)
        .enter()
        .append("text")
        .attr("class", "legend-label")
        .attr("x", boxTextSeperation) // Adjust position relative to boxes
        .attr("y", (d, i) => i * boxSeperation + textVerticalAdjustment) // Align text with boxes
        .text(d => `${d.minValue.toFixed(1)} - ${d.maxValue.toFixed(1)}`); // Format text labels for ranges


      let legend2 = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${countyLegendX}, ${countyLegendY})`); // Adjust x, y to position your legend const
      numberOfStepsCounty = colorScaleCounty.range().length;
      const legendDataCounty = colorScaleCounty.range().map((color, i) => {
        const extent = colorScaleCounty.invertExtent(color);
        return {
          color: color,
          minValue: extent[0],
          maxValue: extent[1]
        };
      });


      // Draw legend boxes
      legend2.selectAll(".legend-box")
        .data(legendDataCounty)
        .enter()
        .append("rect")
        .attr("class", "legend-box")
        .attr("x", 0)
        .attr("y", (d, i) => i * boxSeperation) // Adjust spacing between boxes
        .attr("width", boxWidth) // Adjust size of legend boxes
        .attr("height", boxHeight)
        .style("fill", d => d.color);

      // Add legend labels
      legend2.selectAll(".legend-label")
        .data(legendDataCounty)
        .enter()
        .append("text")
        .attr("class", "legend-label")
        .attr("x", boxTextSeperation) // Adjust position relative to boxes
        .attr("y", (d, i) => i * boxSeperation + textVerticalAdjustment) // Align text with boxes
        .text(d => `${d.minValue.toFixed(1)} - ${d.maxValue.toFixed(1)}`); // Format text labels for ranges
      //


      let states = topojson.feature(topo, topo.objects.states);
      let statesMesh = topojson.mesh(topo, topo.objects.states);
      let counties = topojson.feature(topo, topo.objects.counties);
      let countiesMesh = topojson.mesh(topo, topo.objects.counties);

      let map = d3.select("svg#chloroMap");
      let w = map.attr("width");
      let h = map.attr("height");
      let projection = d3.geoAlbersUsa().fitSize([w, h], states);
      let path = d3.geoPath().projection(projection);

      let viewport = map.append("g");

      viewport.selectAll(".state").data(states.features)
        .enter()
        .append("path")
        .attr("class", "state")
        .attr("id", d => d.id)
        .attr("d", path);

      viewport.append("path")
        .datum(statesMesh)
        .attr("class", "state-outline")
        .attr("d", path);


      viewport.selectAll(".county").data(counties.features)
        .enter()
        .append("path")
        .attr("class", "county")
        .attr("d", path);

      viewport.append("path")
        .datum(countiesMesh)
        .attr("class", "county-outline")
        .attr("d", path);

      let areaLabel = viewport.append("g");
      let areaLabelRect = areaLabel.append("rect").attr("class", "label");
      let areaLabelName = areaLabel.append("text")
        .attr("class", "label")
        .style("font-size", `${areaNameFontSize}px`);
      let areaLabelStat = areaLabel.append("text")
        .attr("class", "label")
        .style("font-size", `${percentageFontSize}px`);


      //zooming
      var zoom = d3.zoom()
        .scaleExtent([1, 20])
        .translateExtent([[-50, -50], [w + 50, h + 50]])
        .on("zoom", mapZoom);

      map.call(zoom);
      //to hide counties
      map.call(zoom.transform, d3.zoomIdentity);

      function mapZoom({ transform }) {
        viewport.attr("transform", transform.toString());
        viewport.select(".state-outline")
          .style("stroke-width", 2 / transform.k);
        viewport.select(".county-outline")
          .style("stroke-width", 1 / transform.k);
        viewport.select(".county-outline")
          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
        viewport.selectAll(".county")
          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");


        // hover label box
        let newScale = Math.min(Math.max(1 / transform.k, 0.5), 1);
        let curWidth = areaLabelRect.attr("width");
        let newWidth = curWidth * newScale;
        let newHeight = labelRectangleHeight * newScale;
        let newNameFontSize = areaNameFontSize * newScale;


        areaLabelRect
          .attr("width", newWidth)
          .attr("height", newHeight);
        areaLabel.selectAll("text")
          .style("font-size", `${newNameFontSize}px`);
      }


      viewport.selectAll(".state").on("click", mapClicked);
      viewport.selectAll(".county").on("click", mapClicked);

      viewport.selectAll(".state")
        .attr("fill", d => {
          let val = fipsToStats[d.id];
          if (!val) {
            console.error('No data for id:', d.id);
            return '#000'; // Or any fallback color
          }
          return colorScaleState(Number(fipsToStats[d.id]["percentPopDisability"]))
        });

      viewport.selectAll(".county").attr("fill", d => {
        const stats = fipsToStats[d.id];
        if (!stats) {
          // console.log("Missing data for ID:", d.id); // Log missing IDs
          return "#000"; // Default color for missing data
        }
        return colorScaleCounty(Number(stats.percentPopDisability));
      });
      viewport.selectAll(".state").on("mouseover", stateHover).on("mouseleave", stateUnhover);
      viewport.selectAll(".county").on("mouseover", countyHover).on("mouseleave", countyUnhover);



      // viewport.selectAll(".county").on("mouseover", countyHover);




      function stateHover(event, d) {
        d3.selectAll(".state")
          .transition()
          .duration(200)
          .style("opacity", .4);
        d3.select(this).raise()
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "black")
          .style("stroke-width", "3px");

        // label stuff
        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let ty = (bounds[0][1]) - labelVerticalAdjustment;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;
        areaLabel.attr("visibility", "visible");


        let areaName = fipsToStats[d.id]["Geographic Area Name"];
        areaLabelName
          .text(areaName)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", labelRectangleHeight / 3);

        areaLabelStat
          .text(fipsToStats[d.id]["percentPopDisability"] + "%")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", 5 + 2 * labelRectangleHeight / 3);

        areaLabelRect
          .attr("width", areaName.length * pixelsPerLetter)
          .attr("height", labelRectangleHeight)
          .attr("rx", 0)
          .attr("fill", "orangered")

        areaLabel.attr("transform", `translate(${cx - areaLabelRect.attr("width") / 2}, ${ty})`).raise();

        // table stuff

        updateTable(fipsToStats[d.id]);

      }

      function stateUnhover(event, d) {
        d3.selectAll(".state")
          .transition()
          .duration(200)
          .style("opacity", 1)
        d3.select(this).lower()
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "none");

        areaLabelName.text("");
        areaLabel.attr("visibility", "hidden");
      }

      function countyHover(event, d) {
        d3.select(this).raise()
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "black")
          .style("stroke-width", "3px");

        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;
        areaLabel.attr("visibility", "visible");

        let areaName = fipsToStats[d.id]["Geographic Area Name"];
        areaLabelName
          .text(areaName)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", labelRectangleHeight / 3);

        areaLabelStat
          .text(fipsToStats[d.id]["percentPopDisability"] + "%")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", 5 + 2 * labelRectangleHeight / 3);

        areaLabelRect
          .attr("width", areaName.length * pixelsPerLetter)
          .attr("height", labelRectangleHeight)
          .attr("rx", 0)
          .attr("fill", "orangered")
        areaLabel.attr("transform", `translate(${cx - 50}, ${cy - 50})`).raise();

      }

      function countyUnhover(event, d) {
        d3.selectAll(".county")
          .transition()
          .duration(200)
          .style("opacity", 1)
        d3.select(this)
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "none");

        areaLabelName.text("");
        areaLabel.attr("visibility", "hidden");
      }


      function mapClicked(event, d) {
        console.log(d);
        //d is the specific state or county clicked on
        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;

        let scale = Math.max(1, Math.min(10, 0.9 / Math.max(dW / w,
          dH / h)));

        let translate = [w / 2 - cx * scale, h / 2 - cy * scale];

        let newTransform = d3.zoomIdentity
          .translate(translate[0], translate[1])
          .scale(scale);
        map.transition().duration(1000).call(zoom.transform, newTransform);

      }
    }
    makeChloro();
  </script>
</body>

</html>