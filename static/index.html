<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    svg {
      /* border: 1px black solid; */
    }

    .county {
      fill: rgb(211, 211, 211);
      stroke: none;
    }

    .state {
      stroke: none;
    }

    .county-outline {
      stroke: rgb(255, 0, 0);
      stroke-width: 1px;
      fill: none;
    }

    .state-outline {
      stroke: black;
      stroke-width: 2px;
      fill: none;
    }
  </style>
</head>

<body>
  <h1>
    HW2
  </h1>
  <svg id="chloroMap" height="800" width="800"></svg>

  <script>
    async function makeChloro() {
      let topo = await d3.json("us.json");
      let filteredStates = ['78'];
      topo.objects.states.geometries = topo.objects.states.geometries.filter(d => {
        return filteredStates.indexOf(d.id.toString().padStart(2, '0')) === -1;
      });

      let disabilityData = await d3.csv("ACSST1Y2022.S1810-Data.csv");

      disabilityData.forEach(d => {
        d["FIPS_ID"] = Number(d["FIPS_ID"].substr(9));
      });
      // console.log(disabilityData);

      fipsToStats = {};

      disabilityData.forEach(d => {
        fipsToStats[d["FIPS_ID"]] = d;
      });

      console.log(fipsToStats);

      // console.log(topo);

      let allPercentages = d3.map(disabilityData, d => {
        return Number(d.percentPopDisability);

      });

      let percentageExtent = d3.extent(allPercentages);
      let colorScale = d3.scaleOrdinal(percentageExtent, d3.schemeBlues[9]);

      console.log(colorScale(10));


      let states = topojson.feature(topo, topo.objects.states);
      let statesMesh = topojson.mesh(topo, topo.objects.states);
      let counties = topojson.feature(topo, topo.objects.counties);
      let countiesMesh = topojson.mesh(topo, topo.objects.counties);

      let map = d3.select("svg#chloroMap");
      let w = map.attr("width");
      let h = map.attr("height");
      let projection = d3.geoAlbers().fitSize([w, h], states);
      let path = d3.geoPath().projection(projection);

      let viewport = map.append("g");

      viewport.selectAll(".state").data(states.features)
        .enter()
        .append("path")
        .attr("class", "state")
        .attr("d", path);

      viewport.append("path")
        .datum(statesMesh)
        .attr("class", "state-outline")
        .attr("d", path);


      viewport.selectAll(".county").data(counties.features)
        .enter()
        .append("path")
        .attr("class", "county")
        .attr("d", path);

      viewport.append("path")
        .datum(countiesMesh)
        .attr("class", "county-outline")
        .attr("d", path);

      //zooming
      var zoom = d3.zoom()
        .scaleExtent([1, 20])
        .translateExtent([[-50, -50], [w + 50, h + 50]])
        .on("zoom", mapZoom);

      map.call(zoom);
      //to hide counties
      map.call(zoom.transform, d3.zoomIdentity);

      function mapZoom({ transform }) {
        viewport.attr("transform", transform.toString());
        viewport.select(".state-outline")
          .style("stroke-width", 2 / transform.k);
        viewport.select(".county-outline")
          .style("stroke-width", 1 / transform.k);
        viewport.select(".county-outline")
          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
        viewport.selectAll(".county")
          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
      }


      viewport.selectAll(".state").on("click", mapClicked);
      viewport.selectAll(".county").on("click", mapClicked);

      viewport.selectAll(".state")
        .attr("fill", d => colorScale(Number(fipsToStats[d.id]["percentPopDisability"])));


      // viewport.selectAll(".state").on("hover", stateHover);
      // viewport.selectAll(".county").on("hover", stateHover);

      function stateHover(event, d) {
        console.log(d);
      }

      function mapClicked(event, d) {
        console.log(d);
        //d is the specific state or county clicked on
        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;

        let scale = Math.max(1, Math.min(10, 0.9 / Math.max(dW / w,
          dH / h)));

        let translate = [w / 2 - cx * scale, h / 2 - cy * scale];

        let newTransform = d3.zoomIdentity
          .translate(translate[0], translate[1])
          .scale(scale);
        map.transition().duration(1000).call(zoom.transform, newTransform);

      }
    }
    makeChloro();
  </script>
</body>

</html>