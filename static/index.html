<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    svg {
      /* border: 1px black solid; */
      background-color: lightgray;
    }

    .county {
      stroke: none;
    }

    .state {
      stroke: none;
    }

    .county-outline {
      stroke: rgb(255, 255, 255);
      stroke-width: 1px;
      fill: none;
    }

    .state-outline {
      stroke: rgb(255, 255, 255);
      fill: none;
    }

    .label {
      user-select: none;
    }

    table {
      border: 1px solid black;
    }
  </style>
</head>

<body>
  <h1>
    HW2
  </h1>
  <svg id="chloroMap" height="800" width="800"></svg>
  <svg id="legend" height="400" width="400"></svg>
  <div id="table"></div>
  <script>
    /*  
    =================== hover effect ===========================================
    */
    const labelRectangleHeight = 40;
    const pixelsPerLetter = 10; //used to calculate width of rectangle
    const areaNameFontSize = 14;
    const percentageFontSize = 12;
    /*
    =================== color legends ==========================================
    */
    const stateLegendX = 75; //position from top left corner of the second svg. 
    const stateLegendY = 100;

    const countyLegendX = 250;
    const countyLegendY = 100;

    const boxHeight = 20;
    const boxWidth = 20;
    const boxSeperation = 25; //vertical distances between boxes
    const boxTextSeperation = 25; //horizontal distance between start of the leftmost letter and the left of the box 
    const textVerticalAdjustment = 15; //probably don't change this one unless you change font or font size


    /*
    ========================= table ============================================
    */

    const tablePropertyNames = ["Geography", "percentPopDisability"];
    // start work here

    function generateTable(locationObject) {
      let div = document.getElementById("table");
      console.log(div);

      let tbl = document.createElement("table");

      let header = tbl.insertRow();
      for (let i = 0; i < tablePropertyNames.length; i++) {
        let tr = tbl.insertRow();

      }

      div.appendChild(tbl);
    }

    generateTable({});


    async function makeChloro() {
      let topo = await d3.json("us.json");
      let filteredStates = ['72', '78'];
      topo.objects.states.geometries = topo.objects.states.geometries.filter(d => {
        return filteredStates.indexOf(d.id.toString().padStart(2, '0')) === -1;
      });

      let disabilityData = await d3.csv("ACSST5Y2022.S1810-Data.csv");

      disabilityData.forEach(d => {
        d["Geography"] = Number(d["Geography"].substr(9));
        d["percentPopDisability"] = Number(d["percentPopDisability"]);
      });


      // console.log(disabilityData);

      fipsToStats = {};

      disabilityData.forEach(d => {
        fipsToStats[d["Geography"]] = d;
      });

      // console.log(fipsToStats);

      // console.log(topo);

      let allPercentages = d3.map(disabilityData, d => {
        return Number(d.percentPopDisability);
      });
      let statePercentages = disabilityData.map(d => {
        if (!d["Geographic Area Name"].includes(",")) return d["percentPopDisability"];
      });

      let countyPercentages = disabilityData.map(d => {
        if (d["Geographic Area Name"].includes(",")) return d["percentPopDisability"];
      });


      let percentageExtent = d3.extent(allPercentages);
      let colorScaleState = d3.scaleQuantize(d3.extent(statePercentages), d3.schemePurples[9]);
      let colorScaleCounty = d3.scaleQuantize(d3.extent(countyPercentages), d3.schemeBlues[9]);

      console.log(d3.schemeBlues[8]);


      //  
      let svg = d3.select("svg#legend");
      let legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${stateLegendX}, ${stateLegendY})`); // Adjust x, y to position your legend

      const numberOfSteps = colorScaleState.range().length;
      const legendData = colorScaleState.range().map((color, i) => {
        const extent = colorScaleState.invertExtent(color);
        return {
          color: color,
          minValue: extent[0],
          maxValue: extent[1]
        };
      });


      // Draw legend boxes
      legend.selectAll(".legend-box")
        .data(legendData)
        .enter()
        .append("rect")
        .attr("class", "legend-box")
        .attr("x", 0)
        .attr("y", (d, i) => i * boxSeperation) // Adjust spacing between boxes
        .attr("width", boxWidth) // Adjust size of legend boxes
        .attr("height", boxHeight)
        .style("fill", d => d.color);

      // Add legend labels
      legend.selectAll(".legend-label")
        .data(legendData)
        .enter()
        .append("text")
        .attr("class", "legend-label")
        .attr("x", boxTextSeperation) // Adjust position relative to boxes
        .attr("y", (d, i) => i * boxSeperation + textVerticalAdjustment) // Align text with boxes
        .text(d => `${d.minValue.toFixed(1)} - ${d.maxValue.toFixed(1)}`); // Format text labels for ranges


      let legend2 = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${countyLegendX}, ${countyLegendY})`); // Adjust x, y to position your legend      const numberOfStepsCounty = colorScaleCounty.range().length;
      const legendDataCounty = colorScaleCounty.range().map((color, i) => {
        const extent = colorScaleCounty.invertExtent(color);
        return {
          color: color,
          minValue: extent[0],
          maxValue: extent[1]
        };
      });


      // Draw legend boxes
      legend2.selectAll(".legend-box")
        .data(legendDataCounty)
        .enter()
        .append("rect")
        .attr("class", "legend-box")
        .attr("x", 0)
        .attr("y", (d, i) => i * boxSeperation) // Adjust spacing between boxes
        .attr("width", boxWidth) // Adjust size of legend boxes
        .attr("height", boxHeight)
        .style("fill", d => d.color);

      // Add legend labels
      legend2.selectAll(".legend-label")
        .data(legendDataCounty)
        .enter()
        .append("text")
        .attr("class", "legend-label")
        .attr("x", boxTextSeperation) // Adjust position relative to boxes
        .attr("y", (d, i) => i * boxSeperation + textVerticalAdjustment) // Align text with boxes
        .text(d => `${d.minValue.toFixed(1)} - ${d.maxValue.toFixed(1)}`); // Format text labels for ranges
      // 


      let states = topojson.feature(topo, topo.objects.states);
      let statesMesh = topojson.mesh(topo, topo.objects.states);
      let counties = topojson.feature(topo, topo.objects.counties);
      let countiesMesh = topojson.mesh(topo, topo.objects.counties);

      let map = d3.select("svg#chloroMap");
      let w = map.attr("width");
      let h = map.attr("height");
      let projection = d3.geoAlbers().fitSize([w, h], states);
      let path = d3.geoPath().projection(projection);

      let viewport = map.append("g");

      viewport.selectAll(".state").data(states.features)
        .enter()
        .append("path")
        .attr("class", "state")
        .attr("id", d => d.id)
        .attr("d", path);

      viewport.append("path")
        .datum(statesMesh)
        .attr("class", "state-outline")
        .attr("d", path);


      viewport.selectAll(".county").data(counties.features)
        .enter()
        .append("path")
        .attr("class", "county")
        .attr("d", path);

      viewport.append("path")
        .datum(countiesMesh)
        .attr("class", "county-outline")
        .attr("d", path);

      let areaLabel = viewport.append("g");
      let areaLabelRect = areaLabel.append("rect").attr("class", "label");
      let areaLabelName = areaLabel.append("text")
        .attr("class", "label")
        .style("font-size", `${areaNameFontSize}px`);
      let areaLabelStat = areaLabel.append("text")
        .attr("class", "label")
        .style("font-size", `${percentageFontSize}px`);


      //zooming
      var zoom = d3.zoom()
        .scaleExtent([1, 20])
        .translateExtent([[-50, -50], [w + 50, h + 50]])
        .on("zoom", mapZoom);

      map.call(zoom);
      //to hide counties
      map.call(zoom.transform, d3.zoomIdentity);

      function mapZoom({ transform }) {
        viewport.attr("transform", transform.toString());
        viewport.select(".state-outline")
          .style("stroke-width", 2 / transform.k);
        viewport.select(".county-outline")
          .style("stroke-width", 1 / transform.k);
        viewport.select(".county-outline")
          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");
        viewport.selectAll(".county")
          .attr("visibility", (transform.k > 3) ? "visible" : "hidden");


        // hover label box
        let newScale = Math.min(Math.max(1 / transform.k, 0.5), 1); // Example scaling factor, adjust as needed
        let curWidth = areaLabelRect.attr("width");
        let newWidth = curWidth * newScale; // Assuming defaultLabelBoxWidth is defined
        let newHeight = labelRectangleHeight * newScale; // Assuming defaultLabelBoxHeight is defined
        let newNameFontSize = areaNameFontSize * newScale; // Assuming defaultFontSize is defined


        // areaLabelRect
        //   .attr("width", newWidth)
        //   .attr("height", newHeight);
        // areaLabel.selectAll("text") // Assuming you have a way to select all text within areaLabel
        //   .style("font-size", `${newNameFontSize}px`);
      }


      viewport.selectAll(".state").on("click", mapClicked);
      viewport.selectAll(".county").on("click", mapClicked);

      viewport.selectAll(".state")
        .attr("fill", d => {
          let val = fipsToStats[d.id];
          if (!val) {
            console.error('No data for id:', d.id);
            return '#000'; // Or any fallback color
          }
          return colorScaleState(Number(fipsToStats[d.id]["percentPopDisability"]))
        });

      viewport.selectAll(".county").attr("fill", d => {
        const stats = fipsToStats[d.id];
        if (!stats) {
          // console.log("Missing data for ID:", d.id); // Log missing IDs
          return "#000"; // Default color for missing data
        }
        return colorScaleCounty(Number(stats.percentPopDisability));
      });
      viewport.selectAll(".state").on("mouseover", stateHover).on("mouseleave", stateUnhover);
      viewport.selectAll(".county").on("mouseover", countyHover).on("mouseleave", countyUnhover);



      // viewport.selectAll(".county").on("mouseover", countyHover);




      function stateHover(event, d) {
        d3.selectAll(".state")
          .transition()
          .duration(200)
          .style("opacity", .4);
        d3.select(this).raise()
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "black")
          .style("stroke-width", "3px");

        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;
        areaLabel.attr("visibility", "visible");

        let areaName = fipsToStats[d.id]["Geographic Area Name"];
        areaLabelName
          .text(areaName)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", labelRectangleHeight / 3);

        areaLabelStat
          .text(fipsToStats[d.id]["percentPopDisability"] + "%")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", 5 + 2 * labelRectangleHeight / 3);

        areaLabelRect
          .attr("width", areaName.length * pixelsPerLetter)
          .attr("height", labelRectangleHeight)
          .attr("rx", 0)
          .attr("fill", "orangered")
        areaLabel.attr("transform", `translate(${cx - dW / 2}, ${cy - dH})`).raise();

      }

      function stateUnhover(event, d) {
        d3.selectAll(".state")
          .transition()
          .duration(200)
          .style("opacity", 1)
        d3.select(this).lower()
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "none");

        areaLabelName.text("");
        areaLabel.attr("visibility", "hidden");
      }

      function countyHover(event, d) {
        d3.select(this).raise()
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "black")
          .style("stroke-width", "3px");

        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;
        areaLabel.attr("visibility", "visible");

        let areaName = fipsToStats[d.id]["Geographic Area Name"];
        areaLabelName
          .text(areaName)
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", labelRectangleHeight / 3);

        areaLabelStat
          .text(fipsToStats[d.id]["percentPopDisability"] + "%")
          .attr("text-anchor", "middle")
          .attr("dominant-baseline", "middle")
          .attr("x", (areaName.length * pixelsPerLetter) / 2)
          .attr("y", 5 + 2 * labelRectangleHeight / 3);

        areaLabelRect
          .attr("width", areaName.length * pixelsPerLetter)
          .attr("height", labelRectangleHeight)
          .attr("rx", 0)
          .attr("fill", "orangered")
        areaLabel.attr("transform", `translate(${cx - 50}, ${cy - 50})`).raise();

      }

      function countyUnhover(event, d) {
        d3.selectAll(".county")
          .transition()
          .duration(200)
          .style("opacity", 1)
        d3.select(this)
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "none");

        areaLabelName.text("");
        areaLabel.attr("visibility", "hidden");
      }


      function mapClicked(event, d) {
        console.log(d);
        //d is the specific state or county clicked on
        let bounds = path.bounds(d.geometry);


        let dW = bounds[1][0] - bounds[0][0];
        let dH = bounds[1][1] - bounds[0][1];
        let cx = (bounds[0][0] + bounds[1][0]) / 2;
        let cy = (bounds[0][1] + bounds[1][1]) / 2;

        let scale = Math.max(1, Math.min(10, 0.9 / Math.max(dW / w,
          dH / h)));

        let translate = [w / 2 - cx * scale, h / 2 - cy * scale];

        let newTransform = d3.zoomIdentity
          .translate(translate[0], translate[1])
          .scale(scale);
        map.transition().duration(1000).call(zoom.transform, newTransform);

      }
    }
    makeChloro();
  </script>
</body>

</html>